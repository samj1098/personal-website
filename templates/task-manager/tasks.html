{% extends 'base.html' %}

{% block title %}Tasks{% endblock %}

{% block content %}
<div class="form-wrapper">
    <div class="test-container">
        <h2 style="margin-bottom: 20px;">Your Task List</h2>

        <!-- Form for adding task title + description -->
        <form onsubmit="handleAddTask(event)" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="newTask" placeholder="Enter task title..." required style="padding: 10px; border-radius: 10px; border: 1px solid #ccc;">
            <input type="text" id="newDescription" placeholder="Enter task description..." required style="padding: 10px; border-radius: 10px; border: 1px solid #ccc;">
            <button type="submit" class="btn" style="background-color: #000; color: white;">Add Task</button>
        </form>

        <ul id="taskList" style="list-style: none; padding: 0;"></ul>

        <button onclick="logout()" class="btn" style="background-color: #ff3b30; color: white; margin-top: 20px;">
            Logout
        </button>
    </div>
</div>

<script>
const token = localStorage.getItem("token");
const backendUrl = "http://task-manager-backend-env.us-west-2.elasticbeanstalk.com";

async function fetchTasks() {
    const res = await fetch(`${backendUrl}/tasks`, {
        headers: { Authorization: `Bearer ${token}` }
    });

    const taskList = document.getElementById("taskList");
    taskList.innerHTML = "";

    if (res.ok) {
        const data = await res.json();
        data.forEach(task => {
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.alignItems = "center";
            li.style.justifyContent = "space-between";
            li.style.padding = "8px";

            li.innerHTML = `
                <div>
                    <strong>${task.title}</strong><br>
                    <small>${task.description}</small>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="startEditTask(${task.id}, '${task.title}', '${task.description}')">‚úèÔ∏è</button>
                    <button onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                </div>
            `;
            taskList.appendChild(li);
        });
    }
}

async function handleAddTask(event) {
    event.preventDefault();
    const taskTitle = document.getElementById("newTask").value;
    const taskDescription = document.getElementById("newDescription").value;

    const res = await fetch(`${backendUrl}/tasks`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ title: taskTitle, description: taskDescription })
    });

    if (res.ok) {
        document.getElementById("newTask").value = "";
        document.getElementById("newDescription").value = "";
        fetchTasks();
    } else {
        alert("Error adding task");
    }
}

async function deleteTask(taskId) {
    const res = await fetch(`${backendUrl}/tasks/${taskId}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
    });

    if (res.ok) {
        fetchTasks();
    } else {
        alert("Error deleting task");
    }
}

function startEditTask(taskId, currentTitle, currentDescription) {
    const taskListItem = document.querySelector(`li button[onclick^="startEditTask(${taskId}"]`).parentElement.parentElement;
    taskListItem.innerHTML = `
        <input type="text" value="${currentTitle}" id="edit-title-${taskId}" style="padding:5px; margin-bottom: 5px;">
        <input type="text" value="${currentDescription}" id="edit-desc-${taskId}" style="padding:5px;">
        <button onclick="submitEditTask(${taskId})">Save</button>
        <button onclick="fetchTasks()">Cancel</button>
    `;
}

async function submitEditTask(taskId) {
    const newTitle = document.getElementById(`edit-title-${taskId}`).value;
    const newDescription = document.getElementById(`edit-desc-${taskId}`).value;

    const res = await fetch(`${backendUrl}/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ title: newTitle, description: newDescription })
    });

    if (res.ok) {
        fetchTasks();
    } else {
        alert("Error editing task");
    }
}

function logout() {
    localStorage.removeItem("token");
    window.location.href = "/task-manager/task-manager-login";
}

window.onload = fetchTasks;
</script>
{% endblock %}
