{% extends 'base.html' %}

{% block title %}Tasks{% endblock %}

{% block content %}
<h2>Tasks</h2>

<!-- Add Task -->
<div>
  <input type="text" id="new-task" placeholder="Enter a new task">
  <button onclick="addTask()">Add</button>
</div>

<!-- Task List -->
<ul id="task-list"></ul>

<!-- Logout -->
<button onclick="logout()">Logout</button>

<script>
  const BACKEND_URL = "https://your-backend.com";
  const token = localStorage.getItem("token");

  async function fetchTasks() {
    const res = await fetch(`${BACKEND_URL}/tasks`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const tasks = await res.json();
    const ul = document.getElementById("task-list");
    ul.innerHTML = "";

    tasks.forEach(task => {
      const li = document.createElement("li");
      li.innerHTML = `
        <span contenteditable="false" id="task-${task.id}">${task.title}</span>
        <button onclick="editTask(${task.id})">‚úèÔ∏è</button>
        <button onclick="deleteTask(${task.id})">üóëÔ∏è</button>
      `;
      ul.appendChild(li);
    });
  }

  async function addTask() {
    const title = document.getElementById("new-task").value;
    if (!title.trim()) return;

    await fetch(`${BACKEND_URL}/tasks`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ title })
    });

    document.getElementById("new-task").value = "";
    fetchTasks();
  }

  function editTask(id) {
    const span = document.getElementById(`task-${id}`);
    const isEditing = span.contentEditable === "true";

    if (isEditing) {
      span.contentEditable = "false";
      updateTask(id, span.textContent.trim());
    } else {
      span.contentEditable = "true";
      span.focus();
    }
  }

  async function updateTask(id, title) {
    if (!title) return;
    await fetch(`${BACKEND_URL}/tasks/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ title })
    });
    fetchTasks();
  }

  async function deleteTask(id) {
    await fetch(`${BACKEND_URL}/tasks/${id}`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`
      }
    });
    fetchTasks();
  }

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/task-manager/login";
  }

  window.onload = fetchTasks;
</script>
{% endblock %}
